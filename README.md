# CoolResp или "хватит пытать себя расписанием".
Мечтают ли андроиды об электроовцах? Мечтаете ли вы об удобном расписании? Если да, то с этим может помочь CoolResp - программа для преобразования расписания от учебного отдела УрТИСИ СибГУТИ в читабельный вид, созданная Мирославским И.С. в 2020-м году.  

Конвертер ещё не совершенен: полученное расписание стоит проверять ради своего спокойствия, дизайн использует системные темы, а сам код - чудовищная абберрация из грязнейших костылей и темнейшей магии эльфийских регулярных выражений, автора которой хочется прибить ссылкой на PEP8. Но несмотря на это, конвертер был отлажен на более чем тридцати наборах тестовых данных (исходники и результаты доступны в папках "тесты" и "резы" соответственно), и уже сейчас не содержит видимых проблем: почти мгновенно он делает расписание читаемым и понятным, а возможность настройки респы "только под свои пары" обрадует многих студентов из больших групп.  

Если же внезапно выплывет какой-нибудь баг обработки, ведь учесть абсолютно всё невозможно, то нужно либо попробовать поменять файл расписания вручную, либо написать [мне](https://vk.com/dk905) о проблеме.  

## Используемые технические средства.
Проект полностью написан на python 3.8.3. Представлен модульной системой, основной стиль - процедурный (интерфейс в ООП).
#### Стандартные модули:
|   Модуль   | Версия |                   Назначение                  |
| :--------: | :----: | :-------------------------------------------: |
| datetime   | 3.8.3  | Хранит даты расписания в формате объектов дат |
| re         | 2.2.1  | Регулярные выражения, на них построен парсинг |
| sys        | 3.8.3  | Для завершения процесса приложения            |
| webbrowser | 3.8.3  | Для перехода по ссылке на гит (пункт в меню)  |
#### Внешние модули:
|  Модуль   | Версия |                    Назначение                     |
| :-------: | :----: | :-----------------------------------------------: |
| openpyxl  | 3.0.4  | Форматирование расписание, сохранение его в .xlsx |
| pyexcel   | 0.6.2  | Открытие расписания как из .xls, так и из .xlsx   |
| pyperclip | 1.8.0  | Копирование лога в буфер обмена                   |
| PyQt5     | 5.15.0 | Интерфейс                                         |

## Приступая к работе.
Есть два варианта начала работы с CoolResp:
1) Скачать и открыть исполняемый файл, который запустит готовый к работе конвертер;
2) Загрузить проект из папки CResp, установить недостающие внешние модули, изменить всё под себя, запустить.

И в том и в другом случае, после запуска программа уже предоставит готовый к работе интерфейс - нужно только открыть файл с расписанием, нажать кнопку с зелёной галочкой для его подгрузки, а затем настроить нужные себе параметры и запускать конвертацию.

#### Назначение основных модулей и элементов проекта:
|     Элемент     |                              Назначение                               |
| :-------------: | :-------------------------------------------------------------------: |
| main_PC.py      | Основное приложение, подгружает в себя модули и макет интерфейса      |
| main_gui.py.py  | Код макета интерфейса ПК версии                                       |
| CR_analyze.py   | Модуль анализа                                                        |
| CR_dataset.py   | Модуль с константами вроде списка сокращений типов пар                |
| CR_jsoner.py    | Модуль для записи БД парсинга и анализа в json файл (будущее)         |
| CR_parser.py    | Модуль парсера                                                        |
| CR_reader.py    | Модуль считывания таблицы                                             |
| CR_timer.py     | Модуль с командами для вывода расписания на выбранный день (будущее)  |
| TST.py          | Тестирование данных (альтернатива main_PC.py)                         |

## Навигация по интерфейсу.
Интерфейс у программы довольно простой, каждый элемент при наведении показывает краткую справку о себе.  
<img src="https://github.com/DK905/CoolResp/blob/master/Screens/CR_01.png" width="500">  
Рассматривая его более подробно, можно выделить следующий ряд элементов:  
<img src="https://github.com/DK905/CoolResp/blob/master/Screens/CR_02.png" width="500">  
1)  Раздел помощи. Здесь можно найти ссылку на репозиторий проекта, краткую текстовую справку, а также техническую информацию;  
2)  Текстовое поле для ввода пути к файлу расписания;  
3)  Кнопка выбора файла расписания через диалоговое окно;  
4)  Кнопка подтверждения выбора файла;  
5)  Список листов в выбранном файле;  
6)  Список групп на выбранном листе;  
7)  Выбор подгруппы для типов пары с делением на две подгруппы;  
8)  Выбор подгруппы для типов пары с делением на три подгруппы;  
9)  Чекбокс для сокращения должности преподавателей;  
10) Чекбокс для сокращения предметов;  
11) Чекбокс для сокращения учебных корпусов у кабинетов;  
12) Чекбокс для сокращения подгрупп до одного лишь номера;  
13) Кнопка для конвертации расписания; 
14) Виджет, куда выводятся логи;   
15) Переключатель отображения логов (при нажатии, виджет логов сворачивается).

## В разработке.
- [ ] Мобильное приложение для "а какие пары позавчера/сегодня/через неделю?"
- [ ] Добавление размерности подгруппам (для различия больших и малых подгрупп)
- [ ] Переработка модулей чтения и парсинга, когда учебный отдел переедет на 1С

## Как это устроено.
Чтобы конвертер не казался чёрным ящиком, магически обрабатывающим расписание, далее будет приведено описание идеи преобразования, на примере случая "когда обрабатывается нормальный файл расписания". Надеюсь, оно поможет тем, кто когда-нибудь решит улучшить сей проект.
#### 1) Считывание
Общая схема считывания такова: считывание файла -> выбор нужного листа -> выбор нужной группы -> выделение ячеек расписания, относящихся к выбранной группе.
Для считывания, используется модуль pyexcel - он позволяет взаимодействовать как со старым форматом .xls, так и с новым .xlsx, считывая их в определённый объект (здесь это orderedDict).
После выбора листа, программа ищет строку с группами (в этой строке, первая ячейка всегда называется "дни"), попутно находя ячейку с периодом расписания, и определяя начало "расписательной" части листа (то есть той части, которая и содержит информацию о парах).  Заканчивается расписательная часть строкой, после которой идёт "Начальник УО".
Затем, составляется база разбора - примитивная аппликация ячеек с информацией о парах выбранной группы. Структура базы разбора подробно расписана в документации к модулю считывания.
#### 2) Парсинг
Этап парсинга - самый важный этап: на нём вычленяется вся логическая информация для каждого уникального вида пары. Уникальным видом здесь считается комбинация "день - номер пары - предмет - препод - тип пары - подгруппа". Без парсера, работа программы просто невозможно, но из-за особенностей исходного расписания, парсинг здесь превращается в ядрёную проблему: стабильность работы под вопросом (всегда ведь может появиться новый тип синтаксического косяка), да и коррекция ошибок убивает всю читаемость кода (чего стоит одна только регулярка на 300+ символов).  
<img src="https://github.com/DK905/CoolResp/blob/master/Screens/CR_03.png" width="500">  
Сам процесс парсинга состоит в последовательном вычленении необходимой информации из информационной ячейки. Такая ячейка, в нашем расписании, имеет множество синтаксических ошибок и разных шаблонов порядка записи разных элементов. Однако, существуют и закономерности: предмет всегда начинается только с большой буквы, у препода есть инициалы и т.п.
В процессе парсинга, синтаксические ошибки устраняются самыми разными проверками и ухищрениями, вроде той же регулярки на 300+ символов.
Из известных проблем парсинга, пока что можно выделить только хромую логику логического разброса кабинетов - в проекте реализована лишь её примерная версия, т.к для полноценной нужно выделить закономерности в ~шестиста наборах правильного распределения. Но и в текущем виде она работает почти идеально - за все тесты было обнаружено лишь десять ошибок такого характера.
#### 3) Анализ
Если этап парсинга успешно завершился, то базу парсинга можно спокойно анализировать.
Цель анализа заключается сразу в двух важных задачах:
- [ ] Определить количество подгрупп для каждого типа пары каждого предмета;
- [ ] Найти все случаи неправильной записи типа пары (когда одну из лаб по запаре назвали практикой и т.п).
#### 4) Форматирование
Когда расписание запарсенно и проанализировано, с ним можно делать любые вещи - исследовать на соответствие учебному плану, ужаснуться количеству пар, или сохранить его в читаемой форме.
Для последнего, используется модуль openpyxl - хоть он и работает только с современным форматом .xlsx, его преимущество заключается в колоссальном количестве возможностей для форматирования сохранённых данных.
В процессе форматирования, конвертер объединяет и украшает всё что нужно объединить и украсить, после чего расписание может быть сохранено.

Для подробного описания лучше почитать документацию и комментарии к модулям, но первичное представление может быть получено и по этому скромному гайду.
